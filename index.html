<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Luminary">
<meta name="theme-color" content="#0f0f14">
<title>Luminary</title>
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="app.css">
</head>
<body>

<div class="overlay-bg" id="bgOverlay" onclick="closeSidebar()"></div>

<!-- PANNEAU DE CAPTURE -->
<div class="capture-panel" id="capturePanel">
  <div class="capture-header">
    <h2>ğŸ’¾ Sauvegarder</h2>
    <button class="capture-cancel" onclick="closeCapture()">Annuler</button>
  </div>
  <div class="source-tabs">
    <button class="stab active web"  data-tab="web"     onclick="switchTab('web')">ğŸŒ Web</button>
    <button class="stab"             data-tab="email"   onclick="switchTab('email')">âœ‰ï¸ Email</button>
    <button class="stab"             data-tab="youtube" onclick="switchTab('youtube')">â–¶ï¸ YouTube</button>
    <button class="stab"             data-tab="pdf"     onclick="switchTab('pdf')">ğŸ“„ PDF</button>
  </div>

  <!-- WEB -->
  <div id="fields-web">
    <div class="field"><label>Texte sÃ©lectionnÃ© *</label><textarea id="cpQuote" rows="5" placeholder="Collez ou sÃ©lectionnez le passageâ€¦"></textarea></div>
    <div class="field"><label>Source</label><input id="cpSource" type="text" placeholder="Auteur, site, newsletterâ€¦"></div>
    <div class="field"><label>URL</label><input id="cpUrl" type="url" placeholder="https://â€¦"></div>
    <div class="field"><label>Note</label><textarea id="cpNote" rows="2" placeholder="Ce que Ã§a vous inspireâ€¦"></textarea></div>
    <div class="field"><label>Tags</label><input id="cpTags" type="text" placeholder="IA, design, startupâ€¦"></div>
  </div>

  <!-- EMAIL -->
  <div id="fields-email" style="display:none">
    <div class="field"><label>Texte sÃ©lectionnÃ© *</label><textarea id="cpQuote" rows="5" placeholder="Collez le passageâ€¦"></textarea></div>
    <div class="field"><label>Source</label><input id="cpSource" type="text" placeholder="Newsletter, expÃ©diteurâ€¦"></div>
    <div class="field"><label>Note</label><textarea id="cpNote" rows="2" placeholder="Ce que Ã§a vous inspireâ€¦"></textarea></div>
    <div class="field"><label>Tags</label><input id="cpTags" type="text" placeholder="IA, design, startupâ€¦"></div>
  </div>

  <!-- YOUTUBE -->
  <div id="fields-youtube" style="display:none">
    <div class="field">
      <label>URL YouTube *</label>
      <div class="yt-fetch-row">
        <input id="ytUrlInput" type="url" placeholder="https://youtube.com/watch?v=â€¦">
        <button class="yt-fetch-btn" id="fetchBtn" onclick="fetchTranscript()">â–¶ï¸ Charger</button>
      </div>
    </div>
    <div class="yt-info-box" id="ytInfoBox">
      <img class="yt-thumb" id="ytThumb" src="" alt="">
      <div class="yt-title"   id="ytTitle"></div>
      <div class="yt-channel" id="ytChannel"></div>
    </div>
    <div class="transcript-box" id="transcriptBox">
      <div class="transcript-header">
        <span>ğŸ“ Retranscription â€” appuyez sur les lignes pour sÃ©lectionner</span>
      </div>
      <div class="transcript-scroll" id="transcriptScroll"></div>
      <div class="transcript-actions">
        <button class="btn btn-red" onclick="selectAllTranscript()">Tout sÃ©lectionner</button>
        <button class="btn"         onclick="clearTranscriptSelection()">Effacer</button>
      </div>
    </div>
    <div class="field"><label>Passage sÃ©lectionnÃ©</label><textarea id="cpQuote" rows="3" placeholder="Appuyez sur les lignes ci-dessusâ€¦"></textarea></div>
    <div class="field"><label>Source / ChaÃ®ne</label><input id="cpSource" type="text" placeholder="ChaÃ®ne YouTubeâ€¦"></div>
    <div class="field"><label>URL</label><input id="cpUrl" type="url" placeholder="https://youtube.com/watch?v=â€¦"></div>
    <div class="field"><label>Note</label><textarea id="cpNote" rows="2" placeholder="Ce que Ã§a vous inspireâ€¦"></textarea></div>
    <div class="field"><label>Tags</label><input id="cpTags" type="text" placeholder="IA, design, startupâ€¦"></div>
  </div>

  <!-- PDF -->
  <div id="fields-pdf" style="display:none">
    <div class="field"><label>Texte sÃ©lectionnÃ© *</label><textarea id="cpQuote" rows="5" placeholder="Collez le passage du PDFâ€¦"></textarea></div>
    <div class="field"><label>Source</label><input id="cpSource" type="text" placeholder="Titre, auteurâ€¦"></div>
    <div class="field"><label>Note</label><textarea id="cpNote" rows="2" placeholder="Ce que Ã§a vous inspireâ€¦"></textarea></div>
    <div class="field"><label>Tags</label><input id="cpTags" type="text" placeholder="IA, design, startupâ€¦"></div>
  </div>

  <button class="save-btn" onclick="saveCapture()">Sauvegarder âœ“</button>
</div>

<!-- APP PRINCIPALE -->
<div class="shell" id="mainShell">

  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <div class="logo-mark">âœ¦ Luminary</div>
      <div class="logo-sub">Votre mÃ©moire de lecture</div>
    </div>
    <nav class="nav">
      <div class="nav-group">
        <div class="nav-group-label">Vues</div>
        <button class="nav-btn active" onclick="go('home',this)"><span class="ico">âœ¦</span> Accueil</button>
        <button class="nav-btn" onclick="go('all',this)"><span class="ico">â—ˆ</span> Tous <span class="badge" id="bAll">0</span></button>
        <button class="nav-btn" onclick="go('review',this)"><span class="ico">âŸ³</span> Revue du jour</button>
        <button class="nav-btn" onclick="go('fav',this)"><span class="ico">â˜…</span> Favoris <span class="badge" id="bFav">0</span></button>
      </div>
      <div class="nav-group">
        <div class="nav-group-label">Sources</div>
        <button class="nav-btn" onclick="go('web',this)"><span class="ico">ğŸŒ</span> Web <span class="badge" id="bWeb">0</span></button>
        <button class="nav-btn" onclick="go('email',this)"><span class="ico">âœ‰ï¸</span> Email <span class="badge" id="bEmail">0</span></button>
        <button class="nav-btn" onclick="go('youtube',this)"><span class="ico">â–¶ï¸</span> YouTube <span class="badge" id="bYt">0</span></button>
        <button class="nav-btn" onclick="go('pdf',this)"><span class="ico">ğŸ“„</span> PDF <span class="badge" id="bPdf">0</span></button>
      </div>
      <div class="nav-group">
        <div class="nav-group-label">Outils</div>
        <button class="nav-btn" onclick="go('setup',this)"><span class="ico">âš™</span> Configuration</button>
        <button class="nav-btn" onclick="go('obsidian',this)"><span class="ico">â—†</span> Obsidian</button>
      </div>
    </nav>
    <button class="sidebar-add" onclick="openCapture()">+ Nouvelle capture</button>
  </aside>

  <main class="main">
    <div class="topbar">
      <button class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
      <div class="topbar-title" id="topTitle">Accueil</div>
      <div class="search d-only">
        <span style="color:var(--muted)">âŒ•</span>
        <input type="text" placeholder="Rechercherâ€¦" oninput="handleSearch(this.value)">
      </div>
      <button class="btn d-only" onclick="openCapture()">+ Capturer</button>
    </div>

    <div class="content">

      <!-- ACCUEIL -->
      <div class="view active" id="v-home">
        <div class="stats">
          <div class="stat"><div class="stat-n" id="statTotal">0</div><div class="stat-l">Highlights</div></div>
          <div class="stat"><div class="stat-n" id="statWeek">0</div><div class="stat-l">Cette semaine</div></div>
          <div class="stat"><div class="stat-n" id="statFav">0</div><div class="stat-l">Favoris</div></div>
        </div>
        <div class="daily" id="dailyBox" style="display:none">
          <div class="daily-label">âœ¦ MÃ©moire du jour</div>
          <div class="daily-quote" id="dailyQ"></div>
          <div class="daily-source" id="dailyS"></div>
          <div class="daily-actions">
            <button class="btn" onclick="refreshDaily()">â†» Autre</button>
            <button class="btn obs" id="dailyObsBtn">â—† Obsidian</button>
          </div>
        </div>
        <div class="sec-head"><h3>RÃ©cents</h3><span class="sub" id="recentSub"></span></div>
        <div class="cards-grid" id="recentGrid"></div>
      </div>

      <div class="view" id="v-all"><div class="cards-grid" id="allGrid"></div><div class="empty" id="emptyAll"><div class="ico">â—ˆ</div><p>Aucun highlight</p></div></div>
      <div class="view" id="v-web"><div class="cards-grid" id="webGrid"></div><div class="empty" id="emptyWeb"><div class="ico">ğŸŒ</div><p>Aucune capture web</p></div></div>
      <div class="view" id="v-email"><div class="cards-grid" id="emailGrid"></div><div class="empty" id="emptyEmail"><div class="ico">âœ‰ï¸</div><p>Aucun highlight email</p></div></div>
      <div class="view" id="v-youtube"><div class="cards-grid" id="ytGrid"></div><div class="empty" id="emptyYt"><div class="ico">â–¶ï¸</div><p>Aucune note YouTube</p></div></div>
      <div class="view" id="v-pdf"><div class="cards-grid" id="pdfGrid"></div><div class="empty" id="emptyPdf"><div class="ico">ğŸ“„</div><p>Aucun highlight PDF</p></div></div>
      <div class="view" id="v-fav"><div class="cards-grid" id="favGrid"></div><div class="empty" id="emptyFav"><div class="ico">â˜…</div><p>Aucun favori</p></div></div>
      <div class="view" id="v-review">
        <div class="sec-head"><h3>Revue du jour</h3><span class="sub">5 highlights alÃ©atoires</span></div>
        <div class="cards-grid" id="reviewGrid"></div>
      </div>

      <!-- CONFIGURATION -->
      <div class="view" id="v-setup">
        <div class="guide-card">
          <h4>ğŸ“± Raccourci iOS â€” Share Sheet</h4>
          <p>Installez ce raccourci une fois. Il apparaÃ®t dans Partager de Safari, Mail et YouTube.</p>
          <div class="warn-box">
            <strong>Votre URL de capture :</strong>
            <div class="url-box"><span id="captureUrlText">chargementâ€¦</span><button class="copy-btn" onclick="copyUrl()">Copier</button></div>
          </div>
          <div class="steps">
            <div class="step"><div class="step-n">1</div><div class="step-txt">Ouvrez <strong>Raccourcis</strong> â†’ appuyez <strong>+</strong></div></div>
            <div class="step"><div class="step-n">2</div><div class="step-txt">Ajoutez l'action <strong>Texte</strong> â†’ collez votre URL dedans</div></div>
            <div class="step"><div class="step-n">3</div><div class="step-txt">Remplacez <strong>TEXTE</strong> dans l'URL par la variable <strong>EntrÃ©e du raccourci</strong></div></div>
            <div class="step"><div class="step-n">4</div><div class="step-txt">Ajoutez l'action <strong>Ouvrir les URLs</strong> en dessous</div></div>
            <div class="step"><div class="step-n">5</div><div class="step-txt">Appuyez <strong>â“˜</strong> â†’ activez <strong>Afficher dans le menu Partager</strong> â†’ nommez <strong>Luminary</strong></div></div>
          </div>
        </div>
        <div class="guide-card">
          <h4>ğŸŒ Bookmarklet Mac</h4>
          <p>Copiez ce code, crÃ©ez un signet Safari (âŒ˜D), collez-le comme URL :</p>
          <div class="url-box"><span id="bkLetLink" style="font-size:10px;color:var(--muted)">chargementâ€¦</span><button class="copy-btn" onclick="copyBookmarklet()">Copier</button></div>
        </div>
        <div class="guide-card">
          <h4>â–¶ï¸ YouTube â€” comment capturer</h4>
          <p>Appuyez sur <strong>+ Capturer</strong> â†’ onglet <strong>YouTube</strong> â†’ collez l'URL de la vidÃ©o â†’ appuyez <strong>Charger</strong>. La retranscription complÃ¨te s'affiche ligne par ligne avec les timestamps. Appuyez sur les lignes qui vous intÃ©ressent pour les sÃ©lectionner â€” elles forment votre highlight automatiquement.</p>
        </div>
      </div>

      <!-- OBSIDIAN -->
      <div class="view" id="v-obsidian">
        <div class="obs-section">
          <h4>â—† Votre vault Obsidian</h4>
          <p>Entrez le nom exact de votre vault (sensible Ã  la casse).</p>
          <div class="field">
            <label>Nom du vault</label>
            <div class="obs-row">
              <input id="obsVault" type="text" placeholder="Mon Vault" oninput="saveObs()">
              <button class="btn obs" onclick="testObs()">â—† Tester</button>
            </div>
          </div>
          <div class="field">
            <label>Dossier de destination</label>
            <input id="obsFolder" type="text" placeholder="Luminary" oninput="saveObs()">
          </div>
        </div>
        <div class="obs-section">
          <h4>â—† Format de note gÃ©nÃ©rÃ©</h4>
          <div class="md-box" id="mdPreview"></div>
        </div>
        <div class="obs-section">
          <h4>â—† Export groupÃ©</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn obs" onclick="exportAll()">â—† Tous les highlights</button>
            <button class="btn obs" onclick="exportFavs()">â˜… Favoris seulement</button>
            <button class="btn"     onclick="dlMd()">â¬‡ TÃ©lÃ©charger .md</button>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- NAV MOBILE -->
<div class="mob-nav" id="mobNav">
  <div class="mob-nav-row">
    <button class="mob-btn active" id="mn-home"   onclick="go('home',null,'mn-home')"><span class="ico">âœ¦</span><span class="lbl">Accueil</span></button>
    <button class="mob-btn"        id="mn-all"    onclick="go('all',null,'mn-all')"><span class="ico">â—ˆ</span><span class="lbl">Tous</span></button>
    <button class="mob-btn"        id="mn-review" onclick="go('review',null,'mn-review')"><span class="ico">âŸ³</span><span class="lbl">Revue</span></button>
    <button class="mob-btn"        id="mn-fav"    onclick="go('fav',null,'mn-fav')"><span class="ico">â˜…</span><span class="lbl">Favoris</span></button>
    <button class="mob-btn"        id="mn-obs"    onclick="go('obsidian',null,'mn-obs')"><span class="ico">â—†</span><span class="lbl">Obsidian</span></button>
  </div>
</div>
<button class="mob-fab" id="mobFab" onclick="openCapture()">+</button>

<!-- SHEET DETAIL -->
<div class="overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div id="detailContent"></div>
    <div class="sheet-footer" id="detailFooter"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script src="app.js"></script>
<script>if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');</script>
</body>
</html>
